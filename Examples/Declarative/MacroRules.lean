/- # macro_rules

[`ðŸ·ï¸ãƒ¡ã‚¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°`](./?search=ðŸ·ãƒ¡ã‚¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°)

`macro_rules` ã¯ãƒžã‚¯ãƒ­å±•é–‹ã‚’å®šã‚ã‚‹ãŸã‚ã®æ±Žç”¨çš„ãªã‚³ãƒžãƒ³ãƒ‰ã§ã™ã€‚
-/

/-- `#hello` ã‚³ãƒžãƒ³ãƒ‰ã®æ§‹æ–‡ã®å®šç¾©ã€‚
ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å¼•æ•°ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚ -/
syntax "#hello" (str)? : command

macro_rules
  | `(#hello) => `(#eval "Hello, Lean!")
  | `(#hello $name) => `(#eval s!"Hello, {$name}!")

/-- info: "Hello, Lean!" -/
#guard_msgs in #hello

/-- info: "Hello, world!" -/
#guard_msgs in #hello "world"

/- `macro_rules` ã‚³ãƒžãƒ³ãƒ‰ã¯ä¸Šè¨˜ã®ä¾‹ã®ã‚ˆã†ã«ã€`=>` è¨˜å·ã‚’å¢ƒã«åˆ†ã‹ã‚Œã¦ãŠã‚Šã€å·¦è¾ºã®æ§‹æ–‡è¦ç´ ã‚’å³è¾ºã®æ§‹æ–‡ã«å¤‰æ›ã™ã‚‹ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚ -/

/- ## ä½¿ç”¨ä¾‹

`macro_rules` ã‚’ä½¿ç”¨ã—ã¦ã€é›†åˆã®å†…åŒ…è¨˜æ³• `{x : T | P x}` ã‚’è§£é‡ˆã™ã‚‹ãƒžã‚¯ãƒ­ã‚’å®šç¾©ã™ã‚‹ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚
-/

/-- éƒ¨åˆ†é›†åˆã€‚`Î±` ã®éƒ¨åˆ†é›†åˆ `A âŠ† Î±` ã¯ã€ä»»æ„ã®è¦ç´  `x : Î±` ã«å¯¾ã—ã¦
ãã‚ŒãŒ `A` ã®è¦ç´ ã‹ã©ã†ã‹åˆ¤å®šã™ã‚‹è¿°èªž `A : Î± â†’ Prop` ã¨åŒä¸€è¦–ã§ãã‚‹ã€‚-/
def Set (Î± : Type) := Î± â†’ Prop

namespace Set

variable {Î± : Type}

/-- 1ã¤ã®è¦ç´ ã ã‘ã‹ã‚‰ãªã‚‹é›†åˆ -/
def singleton (a : Î±) : Set Î± := fun x => x = a

/-- é›†åˆã«ï¼‘ã¤è¦ç´ ã‚’è¿½åŠ ã™ã‚‹ -/
def insert (a : Î±) (s : Set Î±) := fun x => x = a âˆ¨ s x

end Set

-- é›†åˆã®æ³¢æ‹¬å¼§è¨˜æ³•ã®å®šç¾©ã€‚
-- æ—¢å­˜ã®è¨˜å·ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«äºŒé‡ã«ã—ã¦ã„ã‚‹ã€‚
-- ãªãŠ `term,*` ã¯ `term` ãŒ `,` åŒºåˆ‡ã‚Šã§0å€‹ä»¥ä¸Šç¶šãåˆ—ã‚’è¡¨ã™ã€‚
syntax "{{" term,* "}}" : term

-- `syntax` ã‚³ãƒžãƒ³ãƒ‰ã¯è¨˜æ³•ã®è§£é‡ˆæ–¹æ³•ã‚’æ±ºã‚ã¦ã„ãªã„ã®ã§ã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
#guard_msgs (drop warning) in --#
#check_failure {{2, 3}}

-- é›†åˆã®æ³¢æ‹¬å¼§è¨˜æ³•ã‚’ã©ã†è§£é‡ˆã™ã‚‹ã‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å®šã‚ã‚‹
macro_rules
  | `(term| {{$x}}) => `(Set.singleton $x)
  | `(term| {{$x, $xs:term,*}}) => `(Set.insert $x {{$xs,*}})

-- é›†åˆã®æ³¢æ‹¬å¼§è¨˜æ³•ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸ
#check ({{2, 3, 4, 5}} : Set Nat)

/- ## å±•é–‹ãƒ«ãƒ¼ãƒ«ã®ä¸Šæ›¸ãã¨è¿½åŠ 

ä¸€ã¤ã®æ§‹æ–‡ã«å¯¾ã—ã¦ `macro_rules` ã§è¤‡æ•°ã®å±•é–‹ãƒ«ãƒ¼ãƒ«ã‚’å®£è¨€ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ã¨ãã€æœ€å¾Œã«å®£è¨€ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã‹ã‚‰å…ˆã«é©ç”¨ã•ã‚Œã¾ã™ã€‚
-/

/-- æŒ¨æ‹¶ã™ã‚‹ã‚³ãƒžãƒ³ãƒ‰ -/
syntax "#greet" : command

-- `#greet` ã¨ã„ã†æ§‹æ–‡ã«2ã¤ã®å±•é–‹ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©

macro_rules
  | `(command| #greet) => `(#eval "Hello, Lean!")

macro_rules
  | `(command| #greet) => `(#eval "Good morning, Lean!")

-- æœ€å¾Œã«å®£è¨€ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ãŒé©ç”¨ã•ã‚Œã‚‹
/-- info: "Good morning, Lean!" -/
#guard_msgs in #greet

/- ã“ã®ã¨ãå¤ã„æ–¹ã®å±•é–‹ãƒ«ãƒ¼ãƒ«ã¯å¸¸ã«ä¸Šæ›¸ãã•ã‚Œã¦æ¶ˆãˆã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`macro_rules` ã§å®£è¨€ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã¯æœ€å¾Œã«å®£è¨€ã•ã‚ŒãŸã‚‚ã®ã‹ã‚‰é †ã«è©¦ã•ã‚Œã€å±•é–‹ã«å¤±æ•—ã™ã‚‹ã¨ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€æœ€åˆã«å±•é–‹ã«æˆåŠŸã—ãŸãƒ«ãƒ¼ãƒ«ãŒæŽ¡ç”¨ã•ã‚Œã¾ã™ã€‚å…·ä½“ä¾‹ã§ã“ã®æŒ™å‹•ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
-/

/-- `trivial` ã¨ã„ã†ã‚¿ã‚¯ãƒ†ã‚£ã‚¯ã®é¡žä¼¼ç‰© -/
syntax "my_trivial" : tactic

-- `assumption` ã‚¿ã‚¯ãƒ†ã‚£ã‚¯ã‚’å‘¼ã³å‡ºã™
macro_rules
  | `(tactic| my_trivial) => `(tactic| assumption)

-- `rfl` ã‚¿ã‚¯ãƒ†ã‚£ã‚¯ã‚’å‘¼ã³å‡ºã™
macro_rules
  | `(tactic| my_trivial) => `(tactic| rfl)

-- å¾Œã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ãŒå…ˆã«é©ç”¨ã•ã‚Œã‚‹ã®ã§ã€Lean ã¯ã¾ãš `rfl` ã«å±•é–‹ã—ã‚ˆã†ã¨ã™ã‚‹ã€‚
-- ã—ã‹ã— `rfl` ã¯ã‚´ãƒ¼ãƒ«ã®å½¢ãŒä¸é©åˆ‡ãªã®ã§å¤±æ•—ã™ã‚‹ã€‚
-- ãã®å¾Œ `assumption` ãŒè©¦ã•ã‚Œã€ãã‚Œã¯é€šã‚‹ã€‚
example (P : Prop) (h : P) : P := by
  my_trivial

-- `rfl` ãŒä½¿ã‚ã‚Œã¦é€šã‚‹
example {Î± : Type} (x : Î±) : x = x := by
  my_trivial

/- ## å†å¸°çš„å±•é–‹
`macro_rules` ã®å³è¾ºã«ã€ã“ã‚Œã‹ã‚‰è§£é‡ˆã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹æ§‹æ–‡è‡ªèº«ã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å†å¸°çš„ãªãƒžã‚¯ãƒ­å±•é–‹ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
-/

example {Î± : Type} {P : Prop}(x : Î±) (h : P) : x = x âˆ§ P := by
  -- æœ€åˆã¯ç¤ºã›ãªã„
  fail_if_success my_trivial

  -- æ‰‹å‹•ã§ç¤ºã™
  apply And.intro
  Â· rfl
  Â· assumption

-- å†å¸°çš„ãªãƒžã‚¯ãƒ­å±•é–‹ã‚’å®šç¾©ã€‚
-- `P` ã¨ `Q` ãŒä¸¡æ–¹ `my_trivial` ã§ç¤ºã›ã‚‹ãªã‚‰ã€
-- `P âˆ§ Q` ãŒ `my_trivial` ã§ç¤ºã›ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
macro_rules
  | `(tactic| my_trivial) => `(tactic| apply And.intro <;> my_trivial)

example {Î± : Type} {P : Prop}(x : Î±) (h : P) : x = x âˆ§ P := by
  my_trivial
